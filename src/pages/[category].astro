---
import BaseLayout from "../layouts/BaseLayout.astro";
import PostList from "../components/PostList.astro";
import CategorySidebar from "../components/CategorySidebar.astro";
import { processPosts, sortPostsByDate, getUniqueCategories, getUniqueYears, filterPostsByCategory } from "../lib/posts";

export async function getStaticPaths() {
  const postFiles = import.meta.glob("./posts/*.mdx", { eager: true });
  const posts = processPosts(postFiles);
  const categories = getUniqueCategories(posts, false);

  return categories.map((category) => ({
    params: { category: category.toLowerCase() },
    props: { category, posts },
  }));
}

const { category, posts } = Astro.props;

const filteredPosts = sortPostsByDate(filterPostsByCategory(posts, category));
const allCategories = getUniqueCategories(posts);
const years = getUniqueYears(posts);
---

<BaseLayout title={category} description={`Posts in the category ${category}`}>
  <CategorySidebar
    categories={allCategories}
    currentCategory={category}
    years={years}
    slot="sidebar"
  />
  <h1 class="page-heading">{category}</h1>
  <PostList posts={filteredPosts} />
</BaseLayout>
